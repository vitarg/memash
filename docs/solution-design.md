# Дизайн решения

## Цели
- Исправить экспорт изображения без дублирования текста.
- Сделать загрузку сохраненного состояния устойчивой к ошибкам.
- Поддержать перетаскивание текста на тач-устройствах.
- Обеспечить корректные `id` у color picker.
- Сделать историю изменений консистентной.

## Решение по проблемам

### 1. Дублирование текста при скачивании
**Подход**
- Перед экспортом сохранять текущее состояние канваса.
- Рисовать текст один раз в отдельном проходе, чтобы итог содержал текст, но без повторного наложения.
- После экспорта восстанавливать состояние канваса.

**Варианты**
- А: очищать канвас, рисовать базовое изображение заново, затем текст, экспортировать.
- Б: хранить слой с текстом отдельно (offscreen canvas).

**Выбор**
- Вариант А, как минимально инвазивный. Достаточно получить baseImage через `getImageData` до отрисовки текста и восстановить после.

**Риски**
- При наличии фоновой заливки без изображения нужно явно учитывать состояние до отрисовки текста.

### 2. Краш при битых данных в localStorage
**Подход**
- Обернуть `JSON.parse` в `try/catch`.
- При ошибке удалять `meme` из `localStorage` и продолжать с пустым состоянием.

**Риски**
- Потеря неконсистентного сохранения — приемлемо.

### 3. Перетаскивание текста на тач-устройствах
**Подход**
- Перейти на Pointer Events: `onPointerDown`, `pointermove`, `pointerup`.
- Захватывать указатель через `setPointerCapture`.
- Учитывать тач и мышь единым механизмом.

**Риски**
- Нужна корректная отмена capture при `pointercancel`.

### 4. Некорректные id для color picker
**Подход**
- Пробросить `id` как проп, либо генерировать через `useId()` внутри компонента.
- Использовать уникальные `id` для разных инстансов.

**Риски**
- Нет.

### 5. Изменения параметров текста не попадают в историю
**Подход**
- Вызывать `pushToHistory()` перед применением изменений параметров выбранного текста.
- Для слайдеров/пикеров использовать дебаунс или фиксировать историю по `onMouseUp`/`onPointerUp` (если нужен меньший шум).

**Риски**
- История может разрастись при каждом шаге слайдера. Можно ограничить, если потребуется.

## Нефункциональные требования
- Минимальные изменения API компонентов.
- Без добавления новых зависимостей.
- Поведение истории предсказуемо.

## Тестирование (минимум)
- Скачать изображение с текстом и убедиться, что нет двойной обводки.
- Перезапуск приложения с битым `localStorage.meme` — без краша.
- Перетаскивание текста на мобильном эмуляторе.
- Проверка корректных `label`/`id` для color picker.
- Undo после смены размера/цвета текста.
